<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UserController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">tiketsys</a> &gt; <a href="index.source.html" class="el_package">com.spring.tiketsys.controller.user</a> &gt; <span class="el_source">UserController.java</span></div><h1>UserController.java</h1><pre class="source lang-java linenums">package com.spring.tiketsys.controller.user;

import com.fasterxml.jackson.databind.JsonNode;
import com.spring.tiketsys.config.Encrypter;
import com.spring.tiketsys.config.JsonOptions;
import com.spring.tiketsys.dto.entity.User;
import com.spring.tiketsys.dto.entity.UserType;
import com.spring.tiketsys.security.entity.Message;
import com.spring.tiketsys.security.exceptions.TicketException;
import com.spring.tiketsys.security.jwt.JwtChecker;
import com.spring.tiketsys.security.jwt.JwtProvider;
import com.spring.tiketsys.service.UserService;
import com.spring.tiketsys.service.UserTypeService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.validation.annotation.Validated;
import org.springframework.web.bind.annotation.*;

import java.security.NoSuchAlgorithmException;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

@RestController
@CrossOrigin(origins = &quot;*&quot;)
@RequestMapping(&quot;/api/user&quot;)
<span class="fc" id="L28">public class UserController {</span>
    @Autowired
    UserService userService;
    @Autowired
    UserTypeService userTypeService;
    @Autowired
    JwtProvider jwtProvider;
    @Autowired
    JwtChecker jwtChecker;
    @Autowired
    Encrypter encrypter;
    @GetMapping(&quot;/&quot;)
    public String helloWorld(){
<span class="fc" id="L41">        return &quot;HelloWorld&quot;;</span>
    }

    /**
     * Provide
     * {
     *     username:
     *     password:
     *     userType: [as Role or Type]
     *     name:
     *     lastName:
     *     phone:
     * }
     * @param json
     * @return
     */
    @PostMapping(&quot;/register&quot;)
    public ResponseEntity&lt;?&gt; registerUser(@Validated @RequestBody String json) {
        try{
<span class="fc" id="L60">            return register(json);</span>
<span class="nc" id="L61">        }catch(Exception ex){</span>
<span class="nc" id="L62">            ex.printStackTrace();</span>
<span class="nc" id="L63">            return new ResponseEntity&lt;&gt;(new Message(&quot;Error en registro: &quot;+ex.getMessage()), HttpStatus.BAD_REQUEST);</span>
        }
    }

    /**
     * Provide
     * {
     *     username:
     *     password:
     *     userType: [as Role or Type] [options: cliente, agente, administrador]
     *     name:
     *     lastName:
     *     phone:
     * }
     * @param json
     * @return
     */
    @PostMapping(&quot;/registerSpecial&quot;)
    public ResponseEntity&lt;?&gt; registerUserProtected(@Validated @RequestBody String json,
                                                   @RequestHeader(&quot;Authorization&quot;) String authorizationHeader) {
        try{
<span class="nc bnc" id="L84" title="All 2 branches missed.">            if (!jwtChecker.initCheck(authorizationHeader) ||</span>
<span class="nc bnc" id="L85" title="All 2 branches missed.">                    !jwtChecker.getSubjectType(authorizationHeader).equalsIgnoreCase(&quot;3&quot;)) {</span>
                // Registra una sesión inválida
<span class="nc" id="L87">                return new ResponseEntity&lt;&gt;(new Message(&quot;Sesión inválida&quot;), HttpStatus.FORBIDDEN);</span>
            }

<span class="nc" id="L90">            return register(json);</span>
<span class="nc" id="L91">        }catch(Exception ex){</span>
<span class="nc" id="L92">            ex.printStackTrace();</span>
<span class="nc" id="L93">            return new ResponseEntity&lt;&gt;(new Message(&quot;Error en registro: &quot;+ex.getMessage()), HttpStatus.BAD_REQUEST);</span>
        }
    }

    private ResponseEntity&lt;?&gt; register(String json) throws TicketException, NoSuchAlgorithmException {
<span class="fc" id="L98">        JsonNode jsonNode = new JsonOptions().parseStringJsonNode(json);</span>
<span class="fc" id="L99">        String passwordEncrypted = encrypter.encrypt(jsonNode.get(&quot;password&quot;).asText());</span>
<span class="fc" id="L100">        UserType userType = userTypeService.getByType(jsonNode.get(&quot;userType&quot;).asText());</span>

<span class="pc bpc" id="L102" title="1 of 2 branches missed.">        if(userService.usernameExists(jsonNode.get(&quot;username&quot;).asText())){</span>
<span class="nc" id="L103">            throw new TicketException(&quot;Usuario ya existe&quot;);</span>
        }

<span class="fc" id="L106">        User user = new User(</span>
<span class="fc" id="L107">                jsonNode.get(&quot;username&quot;).asText(),</span>
                passwordEncrypted,
<span class="fc" id="L109">                jsonNode.get(&quot;name&quot;).asText(),</span>
<span class="fc" id="L110">                jsonNode.get(&quot;lastName&quot;).asText(),</span>
<span class="fc" id="L111">                jsonNode.get(&quot;phone&quot;).asText(),</span>
                userType,
                false
        );
        //Registramos el usuario
<span class="fc" id="L116">        userService.registerUser(user);</span>
<span class="fc" id="L117">        return ResponseEntity.status(HttpStatus.CREATED).build();</span>
    }


    @PostMapping(&quot;/get-users&quot;)
    public ResponseEntity&lt;?&gt; getUsers(@RequestHeader(&quot;Authorization&quot;) String authorizationHeader){
        try{
<span class="fc" id="L124">            jwtChecker.checkJWT(authorizationHeader);</span>
<span class="fc" id="L125">            List&lt;Map&lt;String, Object&gt;&gt; users = userService.getAllSecure(jwtChecker.getSubject(authorizationHeader));</span>
<span class="fc" id="L126">            return ResponseEntity.status(HttpStatus.OK).body(users);</span>
<span class="nc" id="L127">        }catch(Exception ex){</span>
<span class="nc" id="L128">            return new ResponseEntity&lt;&gt;(new Message(&quot;usuario o contraseña inválidos&quot;), HttpStatus.NOT_ACCEPTABLE);</span>
        }
    }


    /**
     * Provide:{
     *     username: String
     *     password: String
     * }
     *
     * Returns: {
     *     token: String
     *     user_type: number
     * }
     * @param json
     * @return
     */
    @PostMapping(&quot;/login&quot;)
    public ResponseEntity&lt;?&gt; login(@Validated @RequestBody String json){
        try{
<span class="fc" id="L149">            JsonNode jsonNode = new JsonOptions().parseStringJsonNode(json);</span>
<span class="fc" id="L150">            String username = jsonNode.get(&quot;username&quot;).asText();</span>
<span class="fc" id="L151">            String passwordEncrypted = encrypter.encrypt(jsonNode.get(&quot;password&quot;).asText());</span>
<span class="fc" id="L152">            User user = userService.getUser(username);</span>

<span class="pc bpc" id="L154" title="1 of 2 branches missed.">            if(user.isBlocked()){</span>
<span class="nc" id="L155">                throw new TicketException(&quot;el usuario esta bloqueado&quot;);</span>
            }

<span class="pc bpc" id="L158" title="1 of 2 branches missed.">            if(user.getUsername().equalsIgnoreCase(username) &amp;&amp;</span>
<span class="pc bpc" id="L159" title="1 of 2 branches missed.">            user.getPassword().equals(passwordEncrypted)){</span>
                //handle login
<span class="fc" id="L161">                Map&lt;String, Object&gt; map = new HashMap&lt;&gt;();</span>
<span class="fc" id="L162">                map.put(&quot;username&quot;, username);</span>
<span class="fc" id="L163">                map.put(&quot;user_type&quot;, String.valueOf(user.getUserType().getIdUserType()));</span>
<span class="fc" id="L164">                Map&lt;String, Object&gt; response = new HashMap&lt;&gt;();</span>
<span class="fc" id="L165">                response.put(&quot;jwt&quot;, jwtProvider.generateToken(username, map));</span>
<span class="fc" id="L166">                response.put(&quot;user_type&quot;, user.getUserType());</span>
<span class="fc" id="L167">                return new ResponseEntity&lt;&gt;(response, HttpStatus.OK);</span>
            }else{
<span class="nc" id="L169">                throw new TicketException(&quot;El usuario o la contraseña son incorrectos&quot;);</span>
            }
<span class="nc" id="L171">        }catch(Exception ex){</span>
<span class="nc" id="L172">            return new ResponseEntity&lt;&gt;(new Message(ex.getMessage()), HttpStatus.NOT_ACCEPTABLE);</span>
        }
    }

    /**
     * Provided {
     *     username (String)
     *     blocked (int)
     * }
     * @param authorizationHeader
     * @param json
     * @return
     */
    @PostMapping(&quot;/changeBlock&quot;)
    public ResponseEntity&lt;?&gt; changeBlockUser(@RequestHeader(&quot;Authorization&quot;) String authorizationHeader,
                                             @Validated @RequestBody String json){
        try{
<span class="fc" id="L189">            jwtChecker.checkJWT(authorizationHeader);</span>
<span class="fc" id="L190">            JsonNode jsonNode = new JsonOptions().parseStringJsonNode(json);</span>
<span class="fc" id="L191">            String username = jsonNode.get(&quot;username&quot;).asText();</span>
<span class="pc bpc" id="L192" title="1 of 2 branches missed.">            boolean blocked = (jsonNode.get(&quot;blocked&quot;).asInt() == 1);</span>
<span class="fc" id="L193">            User user = userService.getUser(username);</span>
<span class="fc" id="L194">            user.setBlocked(blocked);</span>
<span class="fc" id="L195">            userService.registerUser(user);</span>
<span class="fc" id="L196">            return ResponseEntity.status(HttpStatus.OK).body(&quot;{}&quot;);</span>
<span class="nc" id="L197">        }catch(Exception ex){</span>
<span class="nc" id="L198">            ex.printStackTrace();</span>
<span class="nc" id="L199">            return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(new Message(ex.getMessage()));</span>
        }
    }

    /**
     * Provided: {
     *     username
     * }
     * @param authorizationHeader
     * @param json
     * @return
     */
    @DeleteMapping(&quot;/delete-user&quot;)
    public ResponseEntity&lt;?&gt; deleteUser(@RequestHeader(&quot;Authorization&quot;) String authorizationHeader,
                                             @Validated @RequestBody String json){
        try{
<span class="nc" id="L215">            jwtChecker.checkJWT(authorizationHeader);</span>
<span class="nc" id="L216">            JsonNode jsonNode = new JsonOptions().parseStringJsonNode(json);</span>
<span class="nc" id="L217">            String username = jsonNode.get(&quot;username&quot;).asText();</span>
<span class="nc" id="L218">            User user = userService.getUser(username);</span>
<span class="nc" id="L219">            userService.deleteUser(user);</span>
<span class="nc" id="L220">            return ResponseEntity.status(HttpStatus.OK).body(&quot;{}&quot;);</span>
<span class="nc" id="L221">        }catch(Exception ex){</span>
<span class="nc" id="L222">            ex.printStackTrace();</span>
<span class="nc" id="L223">            return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(new Message(ex.getMessage()));</span>
        }
    }

    @PostMapping(&quot;/validate&quot;)
    public ResponseEntity&lt;?&gt; validateJWT(@RequestHeader(&quot;Authorization&quot;) String authorizationHeader){
        try{
<span class="fc" id="L230">            jwtChecker.checkJWT(authorizationHeader);</span>
<span class="fc" id="L231">            System.out.println(&quot;JWT Valido&quot;);</span>
<span class="fc" id="L232">            return new ResponseEntity&lt;&gt;(new Message(&quot;Autorizado&quot;), HttpStatus.OK);</span>
<span class="nc" id="L233">        }catch(Exception ex){</span>
<span class="nc" id="L234">            System.out.println(&quot;Sesion invalida&quot;);</span>
<span class="nc" id="L235">            return ResponseEntity.status(HttpStatus.FORBIDDEN).body(new Message(&quot;Sesion invalida: &quot;+ex.getMessage()));</span>

        }
    }

    @PostMapping(&quot;/get-user&quot;)
    public ResponseEntity&lt;?&gt; getUser(@RequestHeader(&quot;Authorization&quot;) String authorizationHeader){
        try{
<span class="nc" id="L243">            jwtChecker.checkJWT(authorizationHeader);</span>
<span class="nc" id="L244">            System.out.println(&quot;JWT Valido&quot;);</span>
<span class="nc" id="L245">            String subject = jwtChecker.getSubject(authorizationHeader);</span>
<span class="nc" id="L246">            String userType = jwtChecker.getSubjectType(authorizationHeader);</span>
<span class="nc" id="L247">            Map&lt;String, String&gt; response = new HashMap&lt;&gt;();</span>
<span class="nc" id="L248">            response.put(&quot;user&quot;, subject);</span>
<span class="nc" id="L249">            response.put(&quot;userType&quot;, userType);</span>
<span class="nc" id="L250">            return ResponseEntity.status(HttpStatus.OK).body(response);</span>
<span class="nc" id="L251">        }catch(Exception ex){</span>
<span class="nc" id="L252">            System.out.println(&quot;Sesion Invalida&quot;);</span>
<span class="nc" id="L253">            return ResponseEntity.status(HttpStatus.FORBIDDEN).body(new Message(&quot;Sesion invalida: &quot;+ex.getMessage()));</span>
        }
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>